<!-- Header -->
<div class="mb-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <button
        type="button"
        (click)="goBack()"
        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:border-gray-600 dark:text-gray-300 dark:bg-gray-800 dark:hover:bg-gray-700">
        <lucide-angular 
          [img]="ArrowLeftIcon" 
          class="h-4 w-4 mr-2"
        ></lucide-angular>
        Back
      </button>
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
          {{ isEditMode() ? 'Edit Sales Order' : 'Create Sales Order' }}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ isEditMode() ? 'Update sales order details' : 'Create a new sales order' }}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Error Alert -->
@if (error()) {
  <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4 dark:bg-red-900/50 dark:border-red-800">
    <div class="flex">
      <div class="flex-shrink-0">
        <lucide-angular [img]="PackageIcon" class="h-5 w-5 text-red-400"></lucide-angular>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800 dark:text-red-200">
          Error
        </h3>
        <div class="mt-2 text-sm text-red-700 dark:text-red-300">
          {{ error() }}
        </div>
      </div>
    </div>
  </div>
}

<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center h-64">
    <app-loading-spinner></app-loading-spinner>
  </div>
} @else {
  <!-- Form -->
  <form [formGroup]="salesOrderForm" (ngSubmit)="onSubmit()" class="space-y-6">
    
    <!-- Customer and Order Information -->
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center">
          <lucide-angular [img]="UsersIcon" class="h-5 w-5 mr-2"></lucide-angular>
          Customer Information
        </h3>
      </div>
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <!-- Customer Selection -->
        <div>
          <label for="customerId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Customer *
          </label>
          <select
            id="customerId"
            formControlName="customerId"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">Select a customer...</option>
            @for (customer of customers(); track customer.id) {
              <option [value]="customer.id">{{ customer.name }}</option>
            }
          </select>
          @if (getFieldError('customerId')) {
            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ getFieldError('customerId') }}</p>
          }
        </div>

        <!-- Reference Number (Display Only for Edit Mode) -->
        @if (isEditMode() && salesOrder()) {
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Reference Number
            </label>
            <div class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 dark:border-gray-600 text-gray-900 dark:text-white">
              {{ salesOrder()?.referenceNumber || 'Auto-generated' }}
            </div>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Reference numbers are auto-generated by the system</p>
          </div>
        } @else {
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Reference Number
            </label>
            <div class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 dark:border-gray-600 text-gray-500 dark:text-gray-400">
              Will be auto-generated
            </div>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Reference numbers are automatically generated when the order is created</p>
          </div>
        }

        <!-- Order Notes -->
        <div class="md:col-span-2">
          <label for="orderNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Order Notes
          </label>
          <textarea
            id="orderNotes"
            formControlName="orderNotes"
            rows="3"
            placeholder="Additional notes for this order..."
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Order Items -->
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center">
          <lucide-angular [img]="ShoppingCartIcon" class="h-5 w-5 mr-2"></lucide-angular>
          Order Items
        </h3>
        <button
          type="button"
          (click)="addOrderItem()"
          class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          <lucide-angular [img]="PlusIcon" class="h-4 w-4 mr-1"></lucide-angular>
          Add Item
        </button>
      </div>
      
      <div class="p-6">
        @if (orderItems.length === 0) {
          <div class="text-center py-8">
            <lucide-angular [img]="PackageIcon" class="mx-auto h-12 w-12 text-gray-400"></lucide-angular>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No items</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding your first item.</p>
            <div class="mt-6">
              <button
                type="button"
                (click)="addOrderItem()"
                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <lucide-angular [img]="PlusIcon" class="h-4 w-4 mr-2"></lucide-angular>
                Add Item
              </button>
            </div>
          </div>
        } @else {
          <div class="space-y-6" formArrayName="orderItems">
            @for (item of orderItems.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-sm font-medium text-gray-900 dark:text-white">Item {{ i + 1 }}</h4>
                  @if (orderItems.length > 1) {
                    <button
                      type="button"
                      (click)="removeOrderItem(i)"
                      class="inline-flex items-center p-1 border border-transparent rounded-full text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                      <lucide-angular [img]="Trash2Icon" class="h-4 w-4"></lucide-angular>
                    </button>
                  }
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  
                  <!-- Product Search with Dropdown -->
                  <div class="lg:col-span-2 relative">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Product *
                    </label>
                    <div class="relative">
                      <input
                        type="text"
                        formControlName="productSearch"
                        placeholder="Search products by name or SKU..."
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
                        [class.border-red-500]="hasFieldError('productId', i)"
                        autocomplete="off"
                        (focus)="onProductSearchFocus(i)"
                        (blur)="onProductSearchBlur(i)"
                      />
                      <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        @if (selectedProducts()[i]) {
                          <button
                            type="button"
                            (click)="clearProductSelection(i)"
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 mr-2">
                            <lucide-angular [img]="Trash2Icon" class="h-4 w-4"></lucide-angular>
                          </button>
                        }
                        <lucide-angular [img]="SearchIcon" class="h-4 w-4 text-gray-400 pointer-events-none"></lucide-angular>
                      </div>
                    </div>
                    
                    <!-- Product Dropdown -->
                    @if (showProductDropdowns()[i] && filteredProducts()[i] && filteredProducts()[i].length > 0) {
                      <div class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-700 shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none">
                        @for (product of filteredProducts()[i]; track product.id) {
                          <div
                            (click)="!isProductOutOfStock(product) && selectProduct(product, i)"
                            class="select-none relative py-3 px-4 transition-colors duration-150"
                            [class.cursor-pointer]="!isProductOutOfStock(product)"
                            [class.hover:bg-gray-100]="!isProductOutOfStock(product)"
                            [class.dark:hover:bg-gray-600]="!isProductOutOfStock(product)"
                            [class.bg-gray-50]="isProductOutOfStock(product)"
                            [class.dark:bg-gray-800]="isProductOutOfStock(product)"
                            [class.opacity-50]="isProductOutOfStock(product)"
                            [class.cursor-not-allowed]="isProductOutOfStock(product)">
                            <div class="flex items-start justify-between">
                              <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2">
                                  <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                    {{ product.name }}
                                  </p>
                                  @if (isProductLowStock(product) && !isProductOutOfStock(product)) {
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">
                                      Low Stock
                                    </span>
                                  }
                                  @if (isProductOutOfStock(product)) {
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">
                                      Out of Stock
                                    </span>
                                  }
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                  SKU: {{ product.sku }}
                                </p>
                                @if (product.description) {
                                  <p class="text-xs text-gray-400 dark:text-gray-500 truncate mt-1">
                                    {{ product.description }}
                                  </p>
                                }
                              </div>
                              <div class="text-right ml-4 flex-shrink-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                  {{ formatCurrency(product.unitPrice) }}
                                </p>
                                <div class="text-xs space-y-0.5">
                                  <!-- Available Stock (Primary) -->
                                  <p [class.text-red-500]="product.availableStock <= 0"
                                     [class.text-yellow-600]="product.availableStock > 0 && isProductLowStock(product)"
                                     [class.text-green-600]="product.availableStock > 0 && !isProductLowStock(product)"
                                     [class.dark:text-red-400]="product.availableStock <= 0"
                                     [class.dark:text-yellow-400]="product.availableStock > 0 && isProductLowStock(product)"
                                     [class.dark:text-green-400]="product.availableStock > 0 && !isProductLowStock(product)">
                                    Available: {{ product.availableStock }}
                                  </p>
                                  <!-- Total Stock -->
                                  @if (product.reservedStock > 0) {
                                    <p class="text-gray-500 dark:text-gray-400">
                                      Total: {{ product.currentStock }}
                                    </p>
                                  }
                                </div>
                              </div>
                            </div>
                          </div>
                        }
                      </div>
                    }
                    
                    @if (showProductDropdowns()[i] && filteredProducts()[i] && filteredProducts()[i].length === 0 && productSearchTerms()[i] && productSearchTerms()[i].length > 0) {
                      <div class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-700 shadow-lg rounded-md py-3 px-4 text-base ring-1 ring-black ring-opacity-5">
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
                          No products found matching "{{ productSearchTerms()[i] }}"
                        </p>
                      </div>
                    }
                    
                    <!-- Selected Product Info -->
                    @if (selectedProducts()[i]) {
                      <div class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-md border border-blue-200 dark:border-blue-800">
                        <div class="flex items-center justify-between">
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-blue-900 dark:text-blue-300">
                              {{ selectedProducts()[i]?.name }} ({{ selectedProducts()[i]?.sku }})
                            </p>
                            <div class="flex items-center space-x-4 mt-1">
                              <span class="text-xs text-blue-700 dark:text-blue-400">
                                Available: {{ selectedProducts()[i]?.availableStock }} units
                              </span>
                              <span class="text-xs text-blue-700 dark:text-blue-400">
                                Price: {{ formatCurrency(selectedProducts()[i]?.unitPrice || 0) }}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                    
                    @if (hasFieldError('productId', i)) {
                      <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ getFieldError('productId', i) }}</p>
                    }
                  </div>

                  <!-- Quantity -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Quantity *
                    </label>
                    <input
                      type="number"
                      formControlName="quantity"
                      min="1"
                      [max]="getAvailableStock(i) || 999999"
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-600 dark:text-white"
                      [class.border-red-500]="hasFieldError('quantity', i)"
                    />
                    @if (selectedProducts()[i]) {
                      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        Max: {{ getAvailableStock(i) }} available
                      </p>
                    }
                    @if (hasFieldError('quantity', i)) {
                      <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ getFieldError('quantity', i) }}</p>
                    }
                  </div>

                  <!-- Unit Price -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Unit Price *
                    </label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500 dark:text-gray-400 sm:text-sm">$</span>
                      </div>
                      <input
                        type="number"
                        formControlName="unitPrice"
                        step="0.01"
                        min="0.01"
                        class="block w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-600 dark:text-white"
                        [class.border-red-500]="hasFieldError('unitPrice', i)"
                      />
                    </div>
                    @if (hasFieldError('unitPrice', i)) {
                      <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ getFieldError('unitPrice', i) }}</p>
                    }
                  </div>

                  <!-- Line Total -->
                  <div class="lg:col-span-4">
                    <div class="flex justify-between items-center pt-2">
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Line Total:</span>
                      <span class="text-lg font-semibold text-gray-900 dark:text-white">
                        {{ formatCurrency(calculateLineTotal(i)) }}
                      </span>
                    </div>
                  </div>

                  <!-- Notes -->
                  <div class="lg:col-span-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Item Notes
                    </label>
                    <textarea
                      formControlName="notes"
                      rows="2"
                      placeholder="Additional notes for this item..."
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
                    ></textarea>
                  </div>
                </div>
              </div>
            }
          </div>
        }
        
        <!-- Order Total -->
        @if (orderItems.length > 0) {
          <div class="mt-6 border-t border-gray-200 dark:border-gray-600 pt-6">
            <div class="flex justify-between items-center">
              <span class="text-lg font-medium text-gray-900 dark:text-white">Order Total:</span>
              <span class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                {{ formatCurrency(calculateOrderTotal()) }}
              </span>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
      <button
        type="button"
        (click)="goBack()"
        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:border-gray-600 dark:text-gray-300 dark:bg-gray-800 dark:hover:bg-gray-700">
        Cancel
      </button>
      <button
        type="submit"
        [disabled]="saving() || !isFormValid()"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
        @if (saving()) {
          <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        } @else {
          <lucide-angular [img]="SaveIcon" class="h-4 w-4 mr-2"></lucide-angular>
        }
        {{ saving() ? 'Saving...' : (isEditMode() ? 'Update Order' : 'Create Order') }}
      </button>
    </div>
  </form>
}

<div class="p-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
        <lucide-angular [img]="Package" class="w-8 h-8 text-blue-600"></lucide-angular>
        Inventory Management
      </h1>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Manage your product inventory and stock levels</p>
    </div>
    <div class="mt-4 sm:mt-0">
      <button 
        (click)="createProduct()"
        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
        <lucide-angular [img]="Plus" class="w-4 h-4"></lucide-angular>
        Add Product
      </button>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
      <!-- Search Input -->
      <div class="flex-1 relative">
        <lucide-angular [img]="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></lucide-angular>
        <input 
          type="text"
          placeholder="Search products by name, SKU, or description..."
          (input)="onSearchChange($event)"
          class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </div>

      <!-- Filters -->
      <div class="flex gap-2 items-center">
        <select 
          [value]="statusFilter()"
          (change)="onStatusFilterChange($event)"
          class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          <option value="all">All Products</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive Only</option>
          <option value="lowStock">Low Stock</option>
          <option value="outOfStock">Out of Stock</option>
        </select>

        <select 
          (change)="onPageSizeChange($event)"
          [value]="pageSize()"
          class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg mb-6 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <lucide-angular [img]="AlertTriangle" class="w-5 h-5 text-red-600 dark:text-red-400"></lucide-angular>
        <p>{{ error() }}</p>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (loading()) {
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-8 text-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600 dark:text-gray-400">Loading products...</p>
    </div>
  } @else {
    <!-- Products Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      @if (products().length === 0) {
        <div class="p-8 text-center">
          <lucide-angular [img]="Package" class="w-12 h-12 text-gray-400 mx-auto mb-4"></lucide-angular>
          <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No products found</h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">Get started by adding your first product to the inventory.</p>
          <button 
            (click)="createProduct()"
            class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <lucide-angular [img]="Plus" class="w-4 h-4"></lucide-angular>
            Add Product
          </button>
        </div>
      } @else {
        <!-- Table Header -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" 
                    (click)="onSort('name')">
                  <div class="flex items-center gap-1">
                    Product
                    @if (sortBy() === 'name') {
                      <span class="text-blue-600">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
                    }
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" 
                    (click)="onSort('sku')">
                  <div class="flex items-center gap-1">
                    SKU
                    @if (sortBy() === 'sku') {
                      <span class="text-blue-600">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
                    }
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" 
                    (click)="onSort('currentstock')">
                  <div class="flex items-center gap-1">
                    Stock Details
                    @if (sortBy() === 'currentstock') {
                      <span class="text-blue-600">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
                    }
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" 
                    (click)="onSort('unitprice')">
                  <div class="flex items-center gap-1">
                    Unit Price
                    @if (sortBy() === 'unitprice') {
                      <span class="text-blue-600">{{ sortDirection() === 'asc' ? '↑' : '↓' }}</span>
                    }
                  </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Cost Price
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Status
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              @for (product of products(); track product.id) {
                <tr [ngClass]="{
                  'hover:bg-gray-50 dark:hover:bg-gray-700': true,
                  'bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500': product.isDeleted,
                  'bg-white dark:bg-gray-800': !product.isDeleted
                }">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div>
                      <div [ngClass]="{
                        'text-sm font-medium flex items-center gap-2': true,
                        'text-gray-500 dark:text-gray-400 line-through': product.isDeleted,
                        'text-gray-900 dark:text-white': !product.isDeleted
                      }">
                        {{ product.name }}
                        @if (product.isDeleted) {
                          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                            Inactive
                          </span>
                        }
                      </div>
                      @if (product.description) {
                        <div [ngClass]="{
                          'text-sm': true,
                          'text-gray-400 dark:text-gray-500': product.isDeleted,
                          'text-gray-500 dark:text-gray-400': !product.isDeleted
                        }">{{ product.description }}</div>
                      }
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span [ngClass]="{
                      'text-sm font-mono': true,
                      'text-gray-400 dark:text-gray-500 line-through': product.isDeleted,
                      'text-gray-900 dark:text-white': !product.isDeleted
                    }">{{ product.sku }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col gap-3">
                      <!-- Available Stock (Primary) - Enhanced -->
                      <div class="flex items-center gap-2">
                        <div class="flex items-center gap-2">
                          @if (!product.isDeleted) {
                            @if (product.availableStock === 0) {
                              <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                            } @else if (product.availableStock <= (product.minimumStock || 0)) {
                              <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                            } @else {
                              <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            }
                          } @else {
                            <div class="w-2 h-2 bg-gray-400 rounded-full opacity-50"></div>
                          }
                          
                          <span [ngClass]="{
                            'text-sm font-bold': true,
                            'text-gray-400 dark:text-gray-500': product.isDeleted,
                            'text-green-700 dark:text-green-400': !product.isDeleted && product.availableStock > 0 && product.availableStock > (product.minimumStock || 0),
                            'text-red-700 dark:text-red-400': !product.isDeleted && product.availableStock === 0,
                            'text-yellow-700 dark:text-yellow-400': !product.isDeleted && product.availableStock > 0 && product.availableStock <= (product.minimumStock || 0)
                          }">{{ product.availableStock }}</span>
                          
                          <span [ngClass]="{
                            'text-xs font-medium': true,
                            'text-gray-400 dark:text-gray-500': product.isDeleted,
                            'text-gray-600 dark:text-gray-400': !product.isDeleted
                          }">available</span>
                        </div>
                      </div>
                      
                      <!-- Stock Breakdown Card -->
                      <div [ngClass]="{
                        'bg-gray-50 dark:bg-gray-700/50 rounded-lg p-2.5 border': true,
                        'border-gray-200 dark:border-gray-600': !product.isDeleted,
                        'border-gray-300 dark:border-gray-500 opacity-60': product.isDeleted
                      }">
                        <div class="space-y-1.5">
                          <!-- Total Stock -->
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1.5">
                              <lucide-angular [img]="Package" class="w-3 h-3 text-blue-500 dark:text-blue-400"></lucide-angular>
                              <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Total:</span>
                            </div>
                            <span [ngClass]="{
                              'text-xs font-semibold': true,
                              'text-gray-400 dark:text-gray-500': product.isDeleted,
                              'text-gray-800 dark:text-gray-200': !product.isDeleted
                            }">{{ product.currentStock }}</span>
                          </div>
                          
                          <!-- Reserved Stock -->
                          @if (product.reservedStock > 0) {
                            <div class="flex items-center justify-between">
                              <div class="flex items-center gap-1.5">
                                <div class="w-3 h-3 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                  <div class="w-1.5 h-1.5 bg-orange-500 rounded-full"></div>
                                </div>
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Reserved:</span>
                              </div>
                              <span [ngClass]="{
                                'text-xs font-semibold': true,
                                'text-gray-400 dark:text-gray-500': product.isDeleted,
                                'text-orange-700 dark:text-orange-400': !product.isDeleted
                              }">{{ product.reservedStock }}</span>
                            </div>
                          }
                          
                          <!-- Minimum Stock Threshold -->
                          @if (product.minimumStock) {
                            <div class="flex items-center justify-between">
                              <div class="flex items-center gap-1.5">
                                <div class="w-3 h-3 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                  <div class="w-1.5 h-1.5 bg-purple-500 rounded-full"></div>
                                </div>
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Min Threshold:</span>
                              </div>
                              <span [ngClass]="{
                                'text-xs font-semibold': true,
                                'text-gray-400 dark:text-gray-500': product.isDeleted,
                                'text-purple-700 dark:text-purple-400': !product.isDeleted
                              }">{{ product.minimumStock }}</span>
                            </div>
                          }
                          
                          <!-- Stock Health Indicator -->
                          @if (!product.isDeleted) {
                            <div class="pt-1 border-t border-gray-200 dark:border-gray-600">
                              <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Health:</span>
                                @if (product.availableStock === 0) {
                                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                                    Critical
                                  </span>
                                } @else if (product.availableStock <= (product.minimumStock || 0)) {
                                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400">
                                    Low
                                  </span>
                                } @else {
                                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                                    Good
                                  </span>
                                }
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span [ngClass]="{
                      'text-sm': true,
                      'text-gray-400 dark:text-gray-500': product.isDeleted,
                      'text-gray-900 dark:text-white': !product.isDeleted
                    }">{{ formatCurrency(product.unitPrice) }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span [ngClass]="{
                      'text-sm': true,
                      'text-gray-400 dark:text-gray-500': product.isDeleted,
                      'text-gray-900 dark:text-white': !product.isDeleted
                    }">{{ formatCurrency(product.costPrice) }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col gap-2">
                      <!-- Stock Status Badge with Icon -->
                      @if (!product.isDeleted) {
                        <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm border"
                             [class]="getStockStatusClass(product)">
                          @if (product.isLowStock || (product.minimumStock && product.availableStock <= product.minimumStock)) {
                            <lucide-angular [img]="AlertTriangle" class="w-3 h-3 mr-1.5"></lucide-angular>
                            Low Stock
                          } @else if (product.availableStock > 0) {
                            <lucide-angular [img]="Package" class="w-3 h-3 mr-1.5"></lucide-angular>
                            In Stock
                          } @else {
                            <lucide-angular [img]="AlertTriangle" class="w-3 h-3 mr-1.5"></lucide-angular>
                            Out of Stock
                          }
                        </div>
                      } @else {
                        <div class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-50 text-gray-400 border border-gray-200 dark:bg-gray-800 dark:text-gray-500 dark:border-gray-600">
                          <lucide-angular [img]="Package" class="w-3 h-3 mr-1.5 opacity-50"></lucide-angular>
                          N/A
                        </div>
                      }
                      
                      <!-- Product Status Badge -->
                      <div class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium border"
                           [class]="product.isDeleted ? 
                             'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800' : 
                             'bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-800'">
                        @if (product.isDeleted) {
                          <div class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5 dark:bg-red-400"></div>
                          Inactive
                        } @else {
                          <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5 dark:bg-emerald-400"></div>
                          Active
                        }
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex items-center justify-end gap-2">
                      @if (!product.isDeleted) {
                        <button
                          (click)="viewProduct(product)"
                          class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 p-1 rounded transition-colors hover:bg-gray-50 dark:hover:bg-gray-900/20"
                          title="View Product">
                          <lucide-angular [img]="Eye" class="w-4 h-4"></lucide-angular>
                        </button>
                        <button
                          (click)="adjustStock(product)"
                          class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 p-1 rounded transition-colors hover:bg-blue-50 dark:hover:bg-blue-900/20"
                          title="Adjust Stock">
                          <lucide-angular [img]="Package" class="w-4 h-4"></lucide-angular>
                        </button>
                        <button
                          (click)="editProduct(product)"
                          class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 p-1 rounded transition-colors hover:bg-indigo-50 dark:hover:bg-indigo-900/20"
                          title="Edit Product">
                          <lucide-angular [img]="Edit" class="w-4 h-4"></lucide-angular>
                        </button>
                        <button
                          (click)="deleteProduct(product)"
                          class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 p-1 rounded transition-colors hover:bg-red-50 dark:hover:bg-red-900/20"
                          title="Delete Product">
                          <lucide-angular [img]="Trash2" class="w-4 h-4"></lucide-angular>
                        </button>
                      } @else {
                        <button
                          (click)="restoreProduct(product)"
                          class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 p-2 rounded-lg transition-colors hover:bg-green-50 dark:hover:bg-green-900/20 border border-green-300 dark:border-green-600"
                          title="Restore Product">
                          <lucide-angular [img]="Trash2" class="w-4 h-4"></lucide-angular>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (totalPages() > 1) {
          <div class="bg-white dark:bg-gray-800 px-4 py-3 border-t border-gray-200 dark:border-gray-700 sm:px-6">
            <div class="flex items-center justify-between">
              <div class="flex-1 flex justify-between sm:hidden">
                <button
                  [disabled]="!hasPreviousPage()"
                  (click)="onPageChange(currentPage() - 1)"
                  class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                  Previous
                </button>
                <button
                  [disabled]="!hasNextPage()"
                  (click)="onPageChange(currentPage() + 1)"
                  class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                  Next
                </button>
              </div>
              <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                  <p class="text-sm text-gray-700 dark:text-gray-300">
                    Showing
                    <span class="font-medium">{{ (currentPage() - 1) * pageSize() + 1 }}</span>
                    to
                    <span class="font-medium">{{ Math.min(currentPage() * pageSize(), totalCount()) }}</span>
                    of
                    <span class="font-medium">{{ totalCount() }}</span>
                    results
                  </p>
                </div>
                <div>
                  <nav class="relative z-0 inline-flex rounded-lg shadow-sm -space-x-px" aria-label="Pagination">
                    <button
                      [disabled]="!hasPreviousPage()"
                      (click)="onPageChange(currentPage() - 1)"
                      class="relative inline-flex items-center px-2 py-2 rounded-l-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                      Previous
                    </button>
                    
                    @for (page of [].constructor(totalPages()); track $index) {
                      @let pageNum = $index + 1;
                      <button
                        (click)="onPageChange(pageNum)"
                        [class]="pageNum === currentPage() ? 
                          'bg-blue-50 dark:bg-blue-900/20 border-blue-500 dark:border-blue-400 text-blue-600 dark:text-blue-400 relative inline-flex items-center px-4 py-2 border text-sm font-medium' :
                          'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 relative inline-flex items-center px-4 py-2 border text-sm font-medium'">
                        {{ pageNum }}
                      </button>
                    }
                    
                    <button
                      [disabled]="!hasNextPage()"
                      (click)="onPageChange(currentPage() + 1)"
                      class="relative inline-flex items-center px-2 py-2 rounded-r-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                      Next
                    </button>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        }
      }
    </div>
  }

  <!-- Stock Adjustment Modal -->
  <app-stock-adjustment-modal
    [isVisible]="showStockAdjustmentModal()"
    [product]="selectedProductForAdjustment()"
    (stockAdjusted)="onStockAdjusted()"
    (cancelled)="onStockAdjustmentCancelled()"
    (visibilityChanged)="showStockAdjustmentModal.set($event)">
  </app-stock-adjustment-modal>
</div>

